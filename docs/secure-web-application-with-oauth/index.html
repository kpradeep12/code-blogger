<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="google-site-verification" content="17GXTKdnqGMgpkrc7Kbz323f4wg41DzBsDcNsfnHmVo" />
<!--below verification is techstackjava.com-->
<meta name="google-site-verification" content="tuMqCtGo9Q2zjZ6e2k1iswdB1R56vqiqYfbSrrzlyRE" />
<meta name="google-site-verification" content="6prhbit_zvr5fgjCg8h5zm8eH7tQrVeMcbHGOhb393g" />
<!-- Twitter cards-->
<meta name="twitter:site"    content="@PradeepK4J">
<meta name="twitter:creator" content="@pradeep">
<meta name="twitter:title"   content="Secure web application with OAuth">

<meta name="twitter:card"  content="summary_large_image">
<meta name="twitter:image" content="http://thetechstack.net/assets/images/banners/kotlin-ktor-oauth.png">

<!-- end of Twitter cards -->


<link rel="icon" href="favicon-32x32.png">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
    
<!--<title>Secure web application with OAuth | The Tech Stack . Net</title>-->
    
<meta name="description" content="This post explains the details needed to authorize users using OAuth. The main advantage of using this approach is that some third party application authorizes users, so it is more secure than storing and maintaining user credentials on the application side."> 
    
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    
<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
    
<link href="/assets/css/screen.css" rel="stylesheet">
    
<link href="/assets/css/main.css" rel="stylesheet">
<link href="/assets/css/custom.css" rel="stylesheet">
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Secure web application with OAuth | Pradeep’s Java blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Secure web application with OAuth" />
<meta name="author" content="pradeep" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post explains the details needed to authorize users using OAuth. The main advantage of using this approach is that some third party application authorizes users, so it is more secure than storing and maintaining user credentials on the application side." />
<meta property="og:description" content="This post explains the details needed to authorize users using OAuth. The main advantage of using this approach is that some third party application authorizes users, so it is more secure than storing and maintaining user credentials on the application side." />
<link rel="canonical" href="http://thetechstack.net/secure-web-application-with-oauth/" />
<meta property="og:url" content="http://thetechstack.net/secure-web-application-with-oauth/" />
<meta property="og:site_name" content="Pradeep’s Java blog" />
<meta property="og:image" content="http://thetechstack.net/assets/images/banners/kotlin-ktor-oauth.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-08T21:11:10-04:00" />
<script type="application/ld+json">
{"image":"http://thetechstack.net/assets/images/banners/kotlin-ktor-oauth.png","description":"This post explains the details needed to authorize users using OAuth. The main advantage of using this approach is that some third party application authorizes users, so it is more secure than storing and maintaining user credentials on the application side.","@type":"BlogPosting","url":"http://thetechstack.net/secure-web-application-with-oauth/","headline":"Secure web application with OAuth","dateModified":"2019-04-08T21:11:10-04:00","datePublished":"2019-04-08T21:11:10-04:00","author":{"@type":"Person","name":"pradeep"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://thetechstack.net/secure-web-application-with-oauth/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-115619272-1', 'auto');
  ga('send', 'pageview');
</script>


</head>
    


<body class="layout-post">

    
<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
    
    <div class="container pr-0">    
    
    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/" alt="The Tech Stack . Net">
    </a>
    <!-- End Logo -->
  
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarMediumish">
       
        <!-- Begin Menu -->
        
            <ul class="navbar-nav ml-auto align-items-center">
                <!--
                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>-->

                <li class="nav-item">
                    <div>
                        <script async src="https://cse.google.com/cse.js?cx=a39f12b298f0f881d"></script>
                        <div class="gcse-search"></div>
                    </div>
                </li>
                
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="dropdown00" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Libraries</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown00">
                        <a class="nav-link" href="/pages/library/docker-images-library/">Docker Image's</a>
                        <a class="nav-link" href="/pages/library/spring-boot-dependencies-library/">Spring Boot Dependencie's</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Quick Reference's</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown01">
                        <a class="nav-link" href="/pages/quick-references/dockerfile-quick-reference/">Dockerfile</a>
                        <a class="nav-link" href="/pages/quick-references/junit-5-quick-reference/">JUnit 5</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="dropdown02" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cheat Sheet's</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown02">
                        <a class="nav-link" href="/pages/cheat-sheets/docker-cli-cheat-sheet/">Docker CLI</a>
                        <a class="nav-link" href="/pages/cheat-sheets/git-cheat-sheet/">Git</a>
                    </div>
                </li>

                
                <li class="nav-item">
                
                <a class="nav-link" href="/about">About Me</a>
                </li>

                <!--
                
                <li class="nav-item">
                
                <a class="nav-link" href="/twitter">Twitter</a>
                </li>
                
                <li class="nav-item">
                <a target="_blank"  class="nav-link" href="https://twitter.com/PradeepK4J"><i class="fab fa-twitter"></i></a>
                </li>-->
                
            </ul>		
  
        <!-- End Menu -->

    </div>
        
    </div>
</nav>
<!-- End Navigation
================================================== -->
    
<div class="site-content">


<div class="container">

    
<!-- Site Title
================================================== -->
<!--<div class="mainheading">
    <h1 class="sitetitle">The Tech Stack . Net</h1>
    <p class="lead">
         Sharing my Java coding experiments
    </p>
</div>-->

    
    
<!-- Content
================================================== --> 
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
	<div class="row">

		<!-- Post Share -->
		<div class="col-md-2 pl-0">            
           <div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=Secure web application with OAuth&url=http://thetechstack.net/secure-web-application-with-oauth/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=http://thetechstack.net/secure-web-application-with-oauth/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://plus.google.com/share?url=http://thetechstack.net/secure-web-application-with-oauth/" onclick="window.open(this.href, 'facebook-google', 'width=550,height=435');return false;">
        <i class="fab fa-google"></i>
        </a>
        </li>
        
    </ul>
    
    <div class="sep">
    </div>				
    <ul>
        <li> 
        <a  class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>  
		</div>
		

		<!-- Post -->        
        
        
		<div class="col-md-9 flex-first flex-md-unordered">
			<div class="mainheading">

                <!-- Author Box -->
                				
				<div class="row post-top-meta">
					<div class="col-md-2">
						<img class="author-thumb" src="/assets/images/author.jpg" alt="Pradeep Kundarapu">
					</div>
					<div class="col-md-10">
                        <a target="_blank" class="link-dark" href="http://thetechstack.net">Pradeep Kundarapu</a>
                        <a target="_blank" href="https://twitter.com/PradeepK4J" class="btn follow">Follow</a>
						<div class="author-description">Java developer, blogger and tech enthusiast.</div>						
					</div>
				</div>				
                
                
                <!-- Post Title -->
				<h1 class="posttitle">Secure web application with OAuth</h1> 
                
			</div>

			<!-- Post Featured Image -->
			<img class="featured-image img-fluid" src="http://thetechstack.net/assets/images/banners/kotlin-ktor-oauth.png" alt="Secure web application with OAuth">
			<!-- End Featured Image -->

			<!-- Post Content -->
			<div class="article-post">
				<p>OAuth is a standard for authenticating users. There are many third-party OAuth authentication service providers are available. In this post, we learn to create a web application which allows users to Login with there Twitter credentials. I am using Ktor to develop this application. This post assumes that users are having basic knowledge of OAuth and Ktor.</p>

<ul id="markdown-toc">
  <li><a href="#create-a-host-entry" id="markdown-toc-create-a-host-entry">Create a host entry</a></li>
  <li><a href="#create-twitter-app" id="markdown-toc-create-twitter-app">Create Twitter app</a></li>
  <li><a href="#create-kotlin-project-with-ktor" id="markdown-toc-create-kotlin-project-with-ktor">Create Kotlin project with Ktor</a>    <ul>
      <li><a href="#add-dependencies" id="markdown-toc-add-dependencies">Add dependencies</a></li>
    </ul>
  </li>
  <li><a href="#coding" id="markdown-toc-coding">Coding</a>    <ul>
      <li><a href="#install-features" id="markdown-toc-install-features">Install features</a></li>
      <li><a href="#configure-routes" id="markdown-toc-configure-routes">Configure routes</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<blockquote>
  <p>This whole project is available in <a href="https://github.com/kpradeep12/techstack-projects/tree/master/ktor-oauth">Github</a></p>
</blockquote>

<p>Below is the application preview of what we are going to develop in this port.</p>

<p><img src="/assets/images/posts/2019/04/ktor-twitter-oauth.gif" alt="Twitter new app" height="496px" width="752px" class="align-center" /></p>

<h3 id="create-a-host-entry">Create a host entry</h3>

<p>While configuring OAuth, we need to provide redirect URLs that can’t be IP addresses or localhost. So for development purpose, we need to create a host which points to 127.0.0.1 in local. We can create a host by editing <strong>hosts</strong> file. You can choose any name for your local domain, but I am going to give it <strong>me.mydomain.com</strong></p>

<p>Update <strong>hosts</strong> file by adding a new entry like shown below. You need root/admin access to edit this file.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">127.0.0.1   me.mydomain.com</code></pre></figure>

<p>In Linux based operating systems this file exists at <strong>/etc/hosts</strong> and in Windows it exists at <strong>%SystemRoot%\System32\drivers\etc\hosts</strong>. Now having a new entry in the host file, we can access local machine using <strong>me.mydomain.com</strong>.</p>

<h3 id="create-twitter-app">Create Twitter app</h3>

<p>This Web application which we are developing in this post allows users to log in with there <strong>Twitter</strong> credentials. However, before that, we need to register our application with <strong>Twitter</strong>, and the below steps will help us in creating a new application with Twitter.</p>

<ul>
  <li>Sign in to twitter developer account <a href="https://developer.twitter.com">https://developer.twitter.com</a>. Create a new account if not exists.</li>
  <li>Create a new app by clicking on <strong>Create an app</strong> button.</li>
  <li>Provide new app details like shown in below.</li>
</ul>

<p><img src="/assets/images/posts/2019/04/twitter-dev-app-1.jpg" alt="Twitter new app" height="400px" width="500px" class="align-center" /></p>

<ul>
  <li>Enter ‘Website URL’ and check ‘Enable Sign in with Twitter’ and then enter ‘Callback URLs.’ as shown in below image. When a user logs in successfully, then Twitter redirects to the given callback URL.</li>
</ul>

<p><img src="/assets/images/posts/2019/04/twitter-dev-app-2.jpg" alt="Twitter new app" height="400px" width="500px" class="align-center" /></p>

<ul>
  <li>Provide your application details in the final text area and then click on ‘Create.’ This action will create a new application.</li>
  <li>Within the application details go to ‘Keys and Tokens’ tab. Here you see the generated Consumer API Keys. We are going to use these values in our application.</li>
</ul>

<p><img src="/assets/images/posts/2019/04/twitter-dev-app-3.png" alt="Twitter new app" height="300px" width="800px" class="align-center" /></p>

<h3 id="create-kotlin-project-with-ktor">Create Kotlin project with Ktor</h3>

<p>Execute below commands to create an empty gradle Kotlin project. Once the project is created then import it into your favorite editor.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">mkdir </span>ktor-oauth
<span class="nb">cd </span>ktor-oauth
gradle init <span class="nt">--type</span> kotlin-application

Select build script DSL:
  1: groovy
  2: kotlin
Enter selection <span class="o">(</span>default: kotlin<span class="o">)</span> <span class="o">[</span>1..2] 

Project name <span class="o">(</span>default: ktor-oauth<span class="o">)</span>: 
Source package <span class="o">(</span>default: ktor.oauth<span class="o">)</span>: net.thetechstack</code></pre></figure>

<blockquote>
  <p>I executed this command on Gradle 5.2.1 version. You can choose to create kotlin project with any other build tool.</p>
</blockquote>

<p>This command will create a new project with standard folder structure.</p>

<h4 id="add-dependencies">Add dependencies</h4>

<p>Update <strong>build.gradle.kts</strong> to add below dependencies;</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">val</span> <span class="n">ktor_version</span> <span class="o">=</span> <span class="s">"1.1.3"</span>
<span class="n">dependencies</span> <span class="o">{</span>
  <span class="c1">//ktor</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"io.ktor:ktor-server-core:$ktor_version"</span><span class="o">)</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"io.ktor:ktor-server-netty:$ktor_version"</span><span class="o">)</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"io.ktor:ktor-jackson:$ktor_version"</span><span class="o">)</span>
  
  <span class="c1">//ktor authentication</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"io.ktor:ktor-auth:$ktor_version"</span><span class="o">)</span>

  <span class="c1">//ktor HTTP client</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"io.ktor:ktor-client-apache:$ktor_version"</span><span class="o">)</span>
  
  <span class="c1">//ktor HTML builder for web pages</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"io.ktor:ktor-html-builder:$ktor_version"</span><span class="o">)</span>

  <span class="c1">//logging</span>
  <span class="n">implementation</span><span class="o">(</span><span class="s">"ch.qos.logback:logback-classic:1.2.3"</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<h3 id="coding">Coding</h3>

<p>Let’s dive into the coding, the most fun part of this post :). This web application which we are developing contains four pages;</p>

<ul>
  <li>Login: Page shows a Twitter link. When the first time user accesses this page, then the user needs to click this link, then the application redirects to Twitter.</li>
  <li>Main: Once user logs-in successfully then they land on this page. This page has two links; one for visit Setting page and other is to Logout.</li>
  <li>Settings: This page contains a link back to the Main page and a link to log out.</li>
  <li>Error: This page shows errors if any.</li>
</ul>

<p>To make it simple, I code everything in a single Kotlin file. Its easier to read and can be used later for reference. Create App.kt in the project and update it with below code;</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">fun</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">embeddedServer</span><span class="o">(</span><span class="n">Netty</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">///code</span>
    <span class="o">}.</span><span class="na">start</span><span class="o">(</span><span class="n">wait</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>We created an embedded Netty server which runs on 8080.</p>

<h4 id="install-features">Install features</h4>

<p>Let’s customize Ktor framework by adding some required features like below;</p>

<ul>
  <li>CallLogging: Logs all HTTP requests. This feature is useful for debugging.</li>
  <li>Sessions: We have multiple pages in our application. A user can navigate between Main and Settings pages, so the session helps in tracking the user state.</li>
  <li>Authentication: The Main motive for this post is to authenticate users, so we need this feature.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">fun</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">embeddedServer</span><span class="o">(</span><span class="n">Netty</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">val</span> <span class="n">authOauthForLogin</span> <span class="o">=</span> <span class="s">"authOauthForLogin"</span>
        <span class="n">install</span><span class="o">(</span><span class="n">CallLogging</span><span class="o">)</span>
        <span class="n">install</span><span class="o">(</span><span class="n">Sessions</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// &lt;1&gt;</span>
            <span class="n">cookie</span><span class="o">&lt;</span><span class="n">MySession</span><span class="o">&gt;(</span><span class="s">"ktorOAuthSessionId"</span><span class="o">,</span> <span class="n">SessionStorageMemory</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">cookie</span><span class="o">.</span><span class="na">path</span> <span class="o">=</span> <span class="s">"/"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">install</span><span class="o">(</span><span class="n">Authentication</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// &lt;2&gt;</span>
            <span class="n">oauth</span><span class="o">(</span><span class="n">authOauthForLogin</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">(</span><span class="n">Apache</span><span class="o">).</span><span class="na">apply</span> <span class="o">{</span>
                    <span class="n">environment</span><span class="o">.</span><span class="na">monitor</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">ApplicationStopping</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">close</span><span class="o">()</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">providerLookup</span> <span class="o">=</span> <span class="o">{</span>
                    <span class="n">OAuthServerSettings</span><span class="o">.</span><span class="na">OAuth1aServerSettings</span><span class="o">(</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s">"twitter"</span><span class="o">,</span>
                            <span class="n">requestTokenUrl</span> <span class="o">=</span> <span class="s">"https://api.twitter.com/oauth/request_token"</span><span class="o">,</span>
                            <span class="n">authorizeUrl</span> <span class="o">=</span> <span class="s">"https://api.twitter.com/oauth/authorize"</span><span class="o">,</span>
                            <span class="n">accessTokenUrl</span> <span class="o">=</span> <span class="s">"https://api.twitter.com/oauth/access_token"</span><span class="o">,</span>
                            
                            <span class="c1">// update below values with your keys</span>
                            <span class="n">consumerKey</span> <span class="o">=</span> <span class="s">"***"</span><span class="o">,</span>
                            <span class="n">consumerSecret</span> <span class="o">=</span> <span class="s">"***"</span> 
                    <span class="o">)</span>
                <span class="o">}</span>
                <span class="n">urlProvider</span> <span class="o">=</span> <span class="o">{</span>
                    <span class="n">redirectUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">start</span><span class="o">(</span><span class="n">wait</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li><strong>&lt;1&gt;</strong> Session: In a web application we can maintain sessions in various ways, but in this application, we are using cookies. We can store cookies either at the client side or server side. Client-side is vulnerable for attacks so let’s store them at the server side in memory. Learn more about configuring sessions in this <a href="https://ktor.io/servers/features/sessions.html">link</a>.</li>
  <li><strong>&lt;2&gt;</strong> Authentication: Since we are using Twitter as an authentication provider, so we need to pass OAuthAuthenticationProvider instance to ‘OAuth’ function. This instance needs three settings;
    <ul>
      <li><strong>client</strong>: We are using Apache HTTPClient. Our application connects to Twitter while authenticating users, so it needs an HTTP client for communication.</li>
      <li><strong>providerLookup</strong>: Pass  OAuthServerSettings instance. This instance contains some vital information related to the authentication service. These settings differ based on the service provider. In the code, I have given dummy text in consumerKey and consumerSecret, but you need to update these with your application-specific values from Twitter.</li>
      <li><strong>urlProvider</strong>: Page to where the application redirects after authentication.</li>
    </ul>
  </li>
</ul>

<h4 id="configure-routes">Configure routes</h4>

<p>We need to configure multiple routes to navigate between the pages.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">fun</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">embeddedServer</span><span class="o">(</span><span class="n">Netty</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//features</span>
      <span class="n">routing</span> <span class="o">{</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">call</span><span class="o">.</span><span class="na">loginPage</span><span class="o">()</span>
            <span class="o">}</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"/main"</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">sessions</span><span class="o">.</span><span class="na">get</span><span class="o">&lt;</span><span class="n">MySession</span><span class="o">&gt;()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">call</span><span class="o">.</span><span class="na">respondRedirect</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">call</span><span class="o">.</span><span class="na">loggedInSuccessResponse</span><span class="o">()</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"/settings"</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">sessions</span><span class="o">.</span><span class="na">get</span><span class="o">&lt;</span><span class="n">MySession</span><span class="o">&gt;()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">call</span><span class="o">.</span><span class="na">respondRedirect</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">call</span><span class="o">.</span><span class="na">accountPreferences</span><span class="o">()</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">call</span><span class="o">.</span><span class="na">sessions</span><span class="o">.</span><span class="na">clear</span><span class="o">&lt;</span><span class="n">MySession</span><span class="o">&gt;()</span>
                <span class="n">call</span><span class="o">.</span><span class="na">response</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Cache-Control"</span><span class="o">,</span> <span class="s">"no-cache, no-store, must-revalidate"</span><span class="o">)</span>
                <span class="n">call</span><span class="o">.</span><span class="na">respondRedirect</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">authenticate</span><span class="o">(</span><span class="n">authOauthForLogin</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">route</span><span class="o">(</span><span class="s">"/login/{type?}"</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Redirects to twitter for authentication</span>
                    <span class="n">param</span><span class="o">(</span><span class="s">"error"</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">handle</span> <span class="o">{</span>
                            <span class="n">call</span><span class="o">.</span><span class="na">loginFailedPage</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">parameters</span><span class="o">.</span><span class="na">getAll</span><span class="o">(</span><span class="s">"error"</span><span class="o">).</span><span class="na">orEmpty</span><span class="o">())</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">handle</span> <span class="o">{</span>
                        <span class="n">val</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="na">authentication</span><span class="o">.</span><span class="na">principal</span><span class="o">&lt;</span><span class="n">OAuthAccessTokenResponse</span><span class="o">.</span><span class="na">OAuth1a</span><span class="o">&gt;()</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">principal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">call</span><span class="o">.</span><span class="na">sessions</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MySession</span><span class="o">(</span><span class="n">principal</span><span class="o">.</span><span class="na">extraParameters</span><span class="o">[</span><span class="s">"screen_name"</span><span class="o">]</span> <span class="o">?:</span> <span class="s">""</span><span class="o">))</span>
                            <span class="n">call</span><span class="o">.</span><span class="na">respondRedirect</span><span class="o">(</span><span class="s">"/main"</span><span class="o">)</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">call</span><span class="o">.</span><span class="na">loginPage</span><span class="o">()</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}.</span><span class="na">start</span><span class="o">(</span><span class="n">wait</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>Below is the list of routes we configured in our code;</p>
<ul>
  <li><strong>/</strong>: Display login page with a link to Twitter. A user needs to log-in before accessing other pages.
    <ul>
      <li><strong>/main</strong>: Main page, from here a user can navigate to settings or log out. Before the page gets loaded, we are checking if the cookie is not null</li>
      <li><strong>/settings</strong>: This page contains links to main and log-out.</li>
      <li><strong>/logout</strong>: Cleans the session and redirects to ‘/.’</li>
      <li><strong>/login/twitter</strong>: Redirect to Twitter for authentication, and this route is within ‘authenticate’ call.  <strong>call.authentication.principal</strong> makes HTTP call to the authentication service. The response of this call is saved in the principal which contains the user details and token. If the principal is found then redirects to /main page else to log-in page.</li>
    </ul>
  </li>
</ul>

<p>We completed configuring all routes, and there are some utility functions which I am using but not explained here. They are self-explanatory, please refer them in the project <a href="https://github.com/kpradeep12/techstack-projects/tree/master/ktor-oauth">here</a>.</p>

<h3 id="conclusion">Conclusion</h3>

<p>We developed a simple kotlin project with Ktor and Authentication features to enable user to login with there Twitter credentials.</p>

			</div>

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2019-04-08">08 Apr 2019</time></span>           
                
                </small>
            </p>
            
			<!-- Post Categories -->
			<div class="after-post-tags">
				<ul class="tags">
                    
                    
                    <li>
                     <a href="/category/kotlin/">kotlin</a>
                    </li>
                    
				</ul>
			</div>
			<!-- End Categories -->
            
            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="http://thetechstack.net/deploy-serverless-kotlin-app-to-amazon-aws/"> &laquo; Deploy Serverless Kotlin App To Amazon AWS</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="http://thetechstack.net/async-method-invocation-design-pattern/">Asyn Method Invocation Design Pattern &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

		</div>
		<!-- End Post -->

	</div>
</div>
<!-- End Article
================================================== -->

  

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">              
                
<section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'thetechstack-net'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
                
            </div>
        </div>
    </div>

<!--End Comments
================================================== -->
</div>

<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span>Never miss any <b>article</b>, subscribe to my newsletter</span>
        <form action="https://thetechstack.us7.list-manage.com/subscribe/post?u=1381d872f022743eb338f00a1&amp;id=88d9fceb21" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>
    
</div>
<!--
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
          
             
              <a href="/category/java">Java (33)</a>
             
              <a href="/category/reactiveX">Reactivex (3)</a>
             
              <a href="/category/docker">Docker (2)</a>
             
              <a href="/category/tools">Tools (1)</a>
             
              <a href="/category/spring">Spring (2)</a>
             
              <a href="/category/kotlin">Kotlin (12)</a>
             
              <a href="/category/cloud">Cloud (1)</a>
            
          
        

		</div>
	</div>
</div>
 -->


<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                 Copyright © 2020 The Tech Stack . Net 
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

   
</div> 
<!-- Placed at the end of the document so the pages load faster -->
    
<script src="/assets/js/jquery.min.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    
<script src="/assets/js/ie10-viewport-bug-workaround.js"></script>
    
<script src="/assets/js/mediumish.js"></script>
    
<script id="dsq-count-scr" src="//thetechstack-net.disqus.com/count.js"></script>
</body>
</html>
